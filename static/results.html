<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluation Results - Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        h1 {
            color: #1a202c;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .status {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-text {
            color: #4a5568;
            font-size: 0.95rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-label {
            font-size: 0.85rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
        }
        .results-table {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        tr:hover {
            background: #f7fafc;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .badge-pass { background: #c6f6d5; color: #22543d; }
        .badge-fail { background: #fed7d7; color: #742a2a; }
        .badge-uncertain { background: #feebc8; color: #744210; }
        .badge-error { background: #e2e8f0; color: #2d3748; }
        .loading {
            text-align: center;
            padding: 60px;
            color: white;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Evaluation Dashboard</h1>
            <div class="status">
                <div class="status-indicator"></div>
                <span class="status-text">Live Updates Active</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Evaluations</div>
                <div class="stat-value" id="totalEvals">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pass Rate</div>
                <div class="stat-value" id="passRate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Latency</div>
                <div class="stat-value" id="avgLatency">0ms</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Models</div>
                <div class="stat-value" id="activeModels">0</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">Pass/Fail Distribution</div>
                <canvas id="verdictChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Model Performance</div>
                <canvas id="modelChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Latency Trend (Last 20)</div>
                <canvas id="latencyChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Evaluations Over Time</div>
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <div class="results-table">
            <div class="chart-title">Recent Evaluations</div>
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Model</th>
                        <th>Prompt</th>
                        <th>Verdict</th>
                        <th>Latency</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <tr><td colspan="5" class="loading">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let ws;
        let charts = {};
        let historyData = [];

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/api/v1/ws`);
            
            ws.onopen = () => console.log('WebSocket connected');
            ws.onmessage = (e) => {
                const update = JSON.parse(e.data);
                handleRealtimeUpdate(update);
            };
            ws.onerror = (e) => console.error('WebSocket error:', e);
            ws.onclose = () => {
                console.log('WebSocket closed, reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        function handleRealtimeUpdate(update) {
            console.log('Real-time update:', update);
            fetchHistory();
        }

        async function fetchHistory() {
            try {
                const res = await fetch('/api/v1/evals/history');
                const data = await res.json();
                historyData = data.results || [];
                updateDashboard();
            } catch (e) {
                console.error('Failed to fetch history:', e);
            }
        }

        function updateDashboard() {
            updateStats();
            updateCharts();
            updateTable();
        }

        function updateStats() {
            const total = historyData.length;
            const passed = historyData.filter(e => e.judge_verdict === 'Pass').length;
            const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;
            
            const latencies = historyData
                .map(e => e.model_output ? parseFloat(e.model_output.match(/\d+/)?.[0] || 0) : 0)
                .filter(l => l > 0);
            const avgLatency = latencies.length > 0 
                ? Math.round(latencies.reduce((a, b) => a + b, 0) / latencies.length)
                : 0;
            
            const models = new Set(historyData.map(e => e.model).filter(Boolean));
            
            document.getElementById('totalEvals').textContent = total;
            document.getElementById('passRate').textContent = passRate + '%';
            document.getElementById('avgLatency').textContent = avgLatency + 'ms';
            document.getElementById('activeModels').textContent = models.size;
        }

        function updateCharts() {
            updateVerdictChart();
            updateModelChart();
            updateLatencyChart();
            updateTimelineChart();
        }

        function updateVerdictChart() {
            const verdicts = historyData.reduce((acc, e) => {
                const v = e.judge_verdict || 'No Judge';
                acc[v] = (acc[v] || 0) + 1;
                return acc;
            }, {});

            const ctx = document.getElementById('verdictChart').getContext('2d');
            if (charts.verdict) charts.verdict.destroy();
            
            charts.verdict = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(verdicts),
                    datasets: [{
                        data: Object.values(verdicts),
                        backgroundColor: ['#48bb78', '#f56565', '#ed8936', '#cbd5e0']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function updateModelChart() {
            const models = historyData.reduce((acc, e) => {
                if (!e.model) return acc;
                if (!acc[e.model]) acc[e.model] = { pass: 0, fail: 0 };
                if (e.judge_verdict === 'Pass') acc[e.model].pass++;
                else if (e.judge_verdict === 'Fail') acc[e.model].fail++;
                return acc;
            }, {});

            const ctx = document.getElementById('modelChart').getContext('2d');
            if (charts.model) charts.model.destroy();
            
            charts.model = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(models),
                    datasets: [
                        {
                            label: 'Pass',
                            data: Object.values(models).map(m => m.pass),
                            backgroundColor: '#48bb78'
                        },
                        {
                            label: 'Fail',
                            data: Object.values(models).map(m => m.fail),
                            backgroundColor: '#f56565'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateLatencyChart() {
            const recent = historyData.slice(0, 20).reverse();
            const latencies = recent.map((e, i) => ({
                x: i + 1,
                y: parseFloat(e.model_output?.match(/\d+/)?.[0] || 0)
            }));

            const ctx = document.getElementById('latencyChart').getContext('2d');
            if (charts.latency) charts.latency.destroy();
            
            charts.latency = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Latency (ms)',
                        data: latencies,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateTimelineChart() {
            const byDate = historyData.reduce((acc, e) => {
                const date = new Date(e.created_at).toLocaleDateString();
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});

            const ctx = document.getElementById('timelineChart').getContext('2d');
            if (charts.timeline) charts.timeline.destroy();
            
            charts.timeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(byDate),
                    datasets: [{
                        label: 'Evaluations',
                        data: Object.values(byDate),
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = historyData.slice(0, 50).map(e => {
                const timestamp = new Date(e.created_at).toLocaleString();
                const prompt = (e.prompt || '').substring(0, 50) + '...';
                const verdict = e.judge_verdict || 'N/A';
                const badgeClass = verdict === 'Pass' ? 'badge-pass' :
                                  verdict === 'Fail' ? 'badge-fail' :
                                  verdict === 'Uncertain' ? 'badge-uncertain' : 'badge-error';
                const latency = e.model_output?.match(/\d+/)?.[0] || 'N/A';
                
                return `
                    <tr>
                        <td>${timestamp}</td>
                        <td>${e.model || 'N/A'}</td>
                        <td>${prompt}</td>
                        <td><span class="badge ${badgeClass}">${verdict}</span></td>
                        <td>${latency}ms</td>
                    </tr>
                `;
            }).join('');
        }

        connectWebSocket();
        fetchHistory();
        setInterval(fetchHistory, 30000);
    </script>
</body>
</html>
